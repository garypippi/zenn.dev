---
title: "Cypressã§Laravel Sanctumãªãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Cypress", "Laravel"]
published: true
---

# Cypressã§ã®ãƒ­ã‚°ã‚¤ãƒ³

ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ç”»é¢ã®ãƒ†ã‚¹ãƒˆã§ã¯ã€UIã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ãªã„ã§`cy.request()`ãªã©ã‚’åˆ©ç”¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚

https://docs.cypress.io/guides/getting-started/testing-your-app#Logging-in

> Don't use your UI to build up state! It's enormously slow, cumbersome, and unnecessary.

# CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ã¨Originãƒ˜ãƒƒãƒ€ãƒ¼

ã¾ãšã¯Sanctumã®[`EnsureFrontendRequestsAreStateful::fromFrontend`](https://github.com/laravel/sanctum/blob/5a602d520474e103174900301d7b791e6d7cd953/src/Http/Middleware/EnsureFrontendRequestsAreStateful.php#L56)ãŒé€šã‚‰ãªã‹ã£ãŸã®ã§ã€é€šã™ãŸã‚ã«Originãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã—ã¦CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™ã€‚

```typescript
cy.request({
    method: 'GET',
    url: `${Cypress.env().apiUrl}/sanctum/csrf-cookie`,
    headers: {
        ['Origin']: `${Cypress.config().baseUrl}`
    }
})
```

ã“ã‚Œã§CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®å…¥ã£ãŸã‚¯ãƒƒã‚­ãƒ¼ãŒä¿æŒã•ã‚Œã¾ã™ã€‚

# X-XSRF-TOKENãƒ˜ãƒƒãƒ€ãƒ¼

CSRFãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚¯ãƒƒã‚­ãƒ¼ã«å…¥ã£ã¦ã„ã¾ã™ãŒã€axiosã®ã‚ˆã†ã«è‡ªå‹•ã§X-XSRF-TOKENãƒ˜ãƒƒãƒ€ãƒ¼ã«è¨­å®šã—ã¦ãã‚Œãªã„ã®ã§æ‰‹å‹•ã§è¨­å®šã—ã¾ã™ã€‚

```typescript
cy.getCookie('XSRF-TOKEN').then(({ value }) => {
    cy.request({
        method: 'POST',
        url: `${Cypress.env().apiUrl}/login`,
        body: {
            user_id: Cypress.env().testUserId,
            password: Cypress.env().testUserPassword,
        },
        headers: {
            ['Origin']: `${Cypress.config().baseUrl}`,
            ['X-XSRF-TOKEN']: decodeURIComponent(value),
            ['Content-Type']: 'application/json'
        }
    })
})
```

ä»¥ä¸Šã‚’ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²ã—ã¦ç½®ã‘ã°ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®ç”»é¢ã®ãƒ†ã‚¹ãƒˆã§ã•ã£ãã‚Šãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã™ã€‚
