---
title: "Neovimã®Builtinã®LSPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã†"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [neovim]
published: true
---

Neovimã«å…¥ã£ã¦ã„ã‚‹LSPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã£ã¦ã¿ã¾ã™ã€‚

```bash
>>> nvim --version
NVIM v0.5.0-dev+nightly
```

ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ã«[vim-plug](https://github.com/junegunn/vim-plug)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

## è¨­å®šé›†ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

### [nvim-lspconfig](https://github.com/neovim/nvim-lspconfig)

LSã®è¨­å®šé›†ã§ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®LSã‚’å‹æ‰‹ã«èµ·å‹•ã—ã¦ãã‚Œã¾ã™ã€‚

```vim
Plug 'neovim/nvim-lspconfig'
```

## è‡ªå‹•è£œå®Œ

omnifuncã‚’ä½¿ã†ã‹ã€ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å°å…¥ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
Builtinã®LSPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã«Luaã§æ›¸ã‹ã‚ŒãŸè‡ªå‹•è£œå®Œã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚

### [completion-nvim](https://github.com/nvim-lua/completion-nvim)

```vim
Plug 'nvim-lua/completion-nvim'
```
ãã®ã¾ã¾ã ã¨ä¸Šã®ã»ã†ã«ãƒãƒƒãƒ•ã‚¡ãŒå‡ºãŸã‚Šã—ã¦å°‘ã—ç…©ã‚ã—ã„ã®ã§æ¨å¥¨è¨­å®šã‚’ãã®ã¾ã¾æ›¸ãã¾ã™ã€‚

```vim
set completeopt=menuone,noinsert,noselect
set shortmess+=c
```

## è¨­å®š

[ã‚­ãƒ¼ãƒãƒƒãƒ—ã¨è‡ªå‹•è£œå®Œã®è¨­å®šä¾‹](https://github.com/neovim/nvim-lspconfig#Keybindings-and-completion)

Luaã§æ›¸ãã¿ãŸã„ã§ã™ã€‚
ä¾‹ã«ãªã‚‰ã£ã¦ãƒ’ã‚¢ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ›¸ã„ã¦ã„ãã®ã§ã™ãŒã€ãã®ã¾ã¾ã ã¨è‰²ãŒã¤ã‹ãªã„ã®ã§ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```vim
let g:vimsyn_embed='lPr'
```

å€‹äººçš„æœ€å°é™è¨­å®šã§ã™ã€‚

```vim
lua << EOF
    local on_attach = function (client, bufnr)
        vim.api.nvim_buf_set_keymap(bufnr, 'n', 'K', '<cmd>lua vim.lsp.buf.hover()<CR>', {noremap = true, silent = true})
        vim.api.nvim_buf_set_keymap(bufnr, 'n', 'gd', '<cmd>lua vim.lsp.buf.definition()<CR>', {noremap = true, silent = true})
        vim.api.nvim_buf_set_keymap(bufnr, 'n', 'gi', '<cmd>lua vim.lsp.buf.implementation()<CR>', {noremap = true, silent = true})
        require('completion').on_attach(client)
    end
    require('lspconfig').vimls.setup({on_attach = on_attach})
    require('lspconfig').tsserver.setup({on_attach = on_attach})
    require('lspconfig').intelephense.setup({on_attach = on_attach})
EOF
```

## ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãŒæ°—ã«ãªã‚‹

ã‚¨ãƒ©ãƒ¼ã‚„ãƒ’ãƒ³ãƒˆã¯virtual textã§è¡Œæœ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ritgpvapc997856mf1hik2x2zkhb)

- ç”»é¢åˆ†å‰²ã—ãŸã¨ãã«è¦‹åˆ‡ã‚Œã‚‹å ´åˆãŒå¤šã„
- å¤§é‡ã«è¡¨ç¤ºã•ã‚Œã‚‹ã¨ã¤ã‚‰ã„

## virtual textã§è¡¨ç¤ºã—ãªã„è¨­å®š

```lua
vim.lsp.handlers["textDocument/publishDiagnostics"] = vim.lsp.with(
    vim.lsp.diagnostic.on_publish_diagnostics, { virtual_text = false }
)
```

ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯`vim.lsp.diagnostic.show_line_diagnostics()`ã§è¦‹ã‚Œã¾ã™ã€‚

## è‰²ã‚’ã¤ã‘ã‚‹

```vim
:help lsp-highlight
```

ä½¿ã£ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒãŒå¯¾å¿œã—ã¦ã„ãªã‹ã£ãŸã®ã§ã€ã‚¨ãƒ©ãƒ¼ã¨ãƒ’ãƒ³ãƒˆã®å°ã ã‘è‰²ã‚’ã¤ã‘ã¦ã¿ã¾ã™ã€‚

```vim
highlight LspDiagnosticsSignError ctermbg=9 ctermfg=15
highlight LspDiagnosticsSignHint ctermbg=142 ctermfg=15
```

![](https://storage.googleapis.com/zenn-user-upload/i73hgnqv0locukmwjfn752nt1maf)

## ä½¿ãˆã‚‹

ç§ãŒLSPé–¢é€£ã‚’ä½¿ã„ã“ãªã›ã¦ã„ãªã„ã›ã„ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€æ™®é€šã«ä½¿ãˆãã†ãªå°è±¡ã§ã™ã€‚
ï¼ˆã„ã¾ã¾ã§ã¯coc.nvimä½¿ã£ã¦ã„ã¾ã—ãŸï¼‰ã€‚
